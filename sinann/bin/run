#!/usr/bin/env node --use_strict --unhandled-rejections=strict

const Addi = require('../src/vm/processor/instruction/addi');
const Bus = require('../src/vm/bus');
const Cmp = require('../src/vm/processor/instruction/cmp');
const Cmpi = require('../src/vm/processor/instruction/cmpi');
const Jl = require('../src/vm/processor/instruction/jl');
const Jmp = require('../src/vm/processor/instruction/jmp');
const Jmpi = require('../src/vm/processor/instruction/jmpi');
const Jne = require('../src/vm/processor/instruction/jne');
const Memory = require('../src/vm/device/memory');
const Mov = require('../src/vm/processor/instruction/mov');
const Movi = require('../src/vm/processor/instruction/movi');
const Noop = require('../src/vm/processor/instruction/noop');
const Processor = require('../src/vm/processor');
const Read = require('../src/vm/processor/instruction/read');
const Readi = require('../src/vm/processor/instruction/readi');
const Rom = require('../src/vm/device/rom');
const Subi = require('../src/vm/processor/instruction/subi');
const Write = require('../src/vm/processor/instruction/write');
const Writei = require('../src/vm/processor/instruction/writei');

let confFile = './conf.js';
let conf;
for (const i in process.argv) {
  if (process.argv[i] === '--conf') {
    confFile = '../' + process.argv[+i + 1];
  }
  if (process.argv[i] === '--inline-conf') {
    conf = JSON.parse(process.argv[+i + 1]);
  }
}

conf = conf || require(confFile);

const bus = new Bus(new Memory);

const firmware = require(`../${conf.firmware}`);
const rom = new Rom(firmware);
bus.registerRom(rom);

const instructions = [
  /* 0x00 */ (r, b) => new Noop(r, b),
  /* 0x01 */ (r, b) => new Movi(r, b),
  /* 0x02 */ (r, b) => new Mov(r, b),
  /* 0x03 */ (r, b) => new Readi(r, b),
  /* 0x04 */ (r, b) => new Read(r, b),
  /* 0x05 */ (r, b) => new Writei(r, b),
  /* 0x06 */ (r, b) => new Write(r, b),
  /* 0x07 */ () => {}, // @TODO: andi
  /* 0x08 */ () => {}, // @TODO: and
  /* 0x09 */ () => {}, // @TODO: ori
  /* 0x0A */ () => {}, // @TODO: or
  /* 0x0B */ (r, b) => new Addi(r, b),
  /* 0x0C */ () => {}, // @TODO: add
  /* 0x0D */ (r, b) => new Subi(r, b),
  /* 0x0E */ () => {}, // @TODO: sub
  /* 0x0F */ (r, b) => new Cmpi(r, b),
  /* 0x10 */ (r, b) => new Cmp(r, b),
  /* 0x11 */ (r, b) => new Jmpi(r, b),
  /* 0x12 */ (r, b) => new Jmp(r, b),
  /* 0x13 */ () => {}, // @TODO: je
  /* 0x14 */ (r, b) => new Jne(r, b),
  /* 0x15 */ (r, b) => new Jl(r, b),
  /* 0x16 */ () => {}, // @TODO: jnl
  /* 0x17 */ () => {}, // @TODO: jg
  /* 0x18 */ () => {}, // @TODO: jng
];
const processor = new Processor({0x00: [0x00, 0x00]}, instructions, bus);
bus.registerProcessor(processor);

bus.registerMemory(new Memory([]));

for (const segment in conf.devices) {
  const deviceConfig = conf.devices[segment];
  let deviceClass;
  if (deviceConfig.type) {
    deviceClass = require(`../src/vm/device/${deviceConfig.type}`);
  } else {
    deviceClass = require(`../${deviceConfig.file}`);
  }
  const device = new deviceClass(deviceConfig.data);
  bus.register(+segment, device);
}

(async() => {
  try {
    await processor.run();
    console.log('VM terminated');
  } catch (e) {
    console.error(`ERROR: ${e}`);
  }
})();
