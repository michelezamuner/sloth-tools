const { promisify } = require('util');
const { exec } = require('child_process');

describe('firmware', () => {
  it('initialize device table address in memory', async() => {
    const conf = {
      firmware: 'src/firmware/firmware.js',
      devices: {
        '0x3': {
          file: 'tests/firmware/mock-device',
          data: [
            // Print device table address
            0x03, 0x00, 0x20, 0x00, // READ R0 MEM:0x000
            0x05, 0x00, 0x30, 0x00, // WRITE R0 MOCK:0x000
            // Shutdown
            0x01, 0x00, 0x00, 0x00, // MOV R0 PROC_SHUTDOWN
            0x05, 0x00, 0x10, 0x00, // WRITE R0 PROC:0x000
          ],
        },
      },
    };

    const result = await promisify(exec)(`bin/run --inline-conf '${JSON.stringify(conf)}'`);

    const output = result.stdout
      .split('')
      .filter(char => char.charCodeAt(0) !== 0)
      .join('');

    expect(output).toMatch('0x20,0x06,VM terminated\n');
  }, 20000);

  it('initialize firmware address in memory', async() => {
    const conf = {
      firmware: 'src/firmware/firmware.js',
      devices: {
        '0x3': {
          file: 'tests/firmware/mock-device',
          data: [
            // Print firmware address
            0x03, 0x00, 0x20, 0x02, // READ R0 MEM:0x002
            0x05, 0x00, 0x30, 0x00, // WRITE R0 MOCK:0x000
            // Shutdown
            0x01, 0x00, 0x00, 0x00, // MOV R0 PROC_SHUTDOWN
            0x05, 0x00, 0x10, 0x00, // WRITE R0 PROC:0x00
          ],
        },
      },
    };

    const result = await promisify(exec)(`bin/run --inline-conf '${JSON.stringify(conf)}'`);

    const output = result.stdout
      .split('')
      .filter(char => char.charCodeAt(0) !== 0)
      .join('');

    expect(output).toMatch('0x20,0x20,VM terminated\n');
  }, 20000);

  it('initialize free memory address in memory', async() => {
    const conf = {
      firmware: 'src/firmware/firmware.js',
      devices: {
        '0x3': {
          file: 'tests/firmware/mock-device',
          data: [
            // Print free memory address
            0x03, 0x00, 0x20, 0x04, // READ R0 MEM:0x004
            0x05, 0x00, 0x30, 0x00, // WRITE R0 MOCK:0x000
            // Shutdown
            0x01, 0x00, 0x00, 0x00, // MOV R0 PROC_SHUTDOWN
            0x05, 0x00, 0x10, 0x00, // WRITE R0 PROC:0x000
          ],
        },
      },
    };

    const result = await promisify(exec)(`bin/run --inline-conf '${JSON.stringify(conf)}'`);

    const output = result.stdout
      .split('')
      .filter(char => char.charCodeAt(0) !== 0)
      .join('');

    expect(output).toMatch('0x20,0xe0,VM terminated\n');
  }, 20000);

  it('copy firmware in memory', async() => {
    const firmware = require('../../src/firmware/firmware');
    const fwla = 0x20 + firmware.length - 2;
    const conf = {
      firmware: 'src/firmware/firmware.js',
      devices: {
        '0x3': {
          file: 'tests/firmware/mock-device',
          data: [
            // RO: current memory address
            // R1: current instruction / comparison result
            /* 0x00 */ 0x01, 0x00, 0x20, 0x1E, // MOV R0 MEM:0x020 - 2
            // LOOP START
            /* 0x004 */ 0x0B, 0x00, 0x00, 0x02, // ADD R0 0x0002
            /* 0x008 */ 0x04, 0x01, 0x00, 0x00, // READ R1 R0
            /* 0x00C */ 0x05, 0x01, 0x30, 0x00, // WRITE R1 MOCK:0x000
            /* 0x010 */ 0x02, 0x01, 0x00, 0x00, // MOV R1 R0
            /* 0x014 */ 0x0F, 0x01, 0x20, fwla, // CMP R1 fw last addr
            /* 0x018 */ 0x15, 0x01, 0x30, 0x04, // JL R1 MOCK:0x004

            // Shutdown
            0x01, 0x00, 0x00, 0x00, // MOV R0 PROC_SHUTDOWN
            0x05, 0x00, 0x10, 0x00, // WRITE R0 PROC:0x000
          ],
        },
      },
    };
    const expected = firmware
      .map(d => `0x${d.toString(16).padStart(2, '0')}`)
      .join(',');

    const result = await promisify(exec)(`bin/run --inline-conf '${JSON.stringify(conf)}'`);

    const output = result.stdout
      .split('')
      .filter(char => char.charCodeAt(0) !== 0)
      .join('');

    expect(output).toMatch(`${expected},VM terminated\n`);
  }, 20000);

  it('create device table', async() => {
    const conf = {
      firmware: 'src/firmware/firmware.js',
      devices: {
        '0x3': {
          file: 'tests/firmware/mock-device',
          data: [
            // R0: current memory address
            // R1: current word / comparison result
            /* 0x000 */ 0x01, 0x00, 0x20, 0x04, // MOV R0 MEM:0x006 - 2
            // LOOP START
            /* 0x004 */ 0x0B, 0x00, 0x00, 0x02, // ADD R0 0x0002
            /* 0x008 */ 0x04, 0x01, 0x00, 0x00, // READ R1 R0
            /* 0x00C */ 0x05, 0x01, 0x30, 0x00, // WRITE R1 MOCK:0x000
            /* 0x010 */ 0x02, 0x01, 0x00, 0x00, // MOV R1 R0
            /* 0x014 */ 0x0F, 0x01, 0x20, 0x1E, // CMP R1 MEM::0x01E
            /* 0x018 */ 0x15, 0x01, 0x30, 0x04, // JL R1 MOCK:0x004

            // Shutdown
            0x01, 0x00, 0x00, 0x00, // MOV R0 PROC_SHUTDOWN
            0x05, 0x00, 0x10, 0x00, // WRITE R0 PROC:0x000
          ],
        },
        '0xA': {
          type: 'rom',
          data: [],
        },
      },
    };
    const expected = [
      0x00, 0x04, // 0x03 mock device
      0xff, 0xff, // 0x04 no device
      0xff, 0xff, // 0x05 no device
      0xff, 0xff, // 0x06 no device
      0xff, 0xff, // 0x07 no device
      0xff, 0xff, // 0x08 no device
      0xff, 0xff, // 0x09 no device
      0x00, 0x01, // 0x0A rom
      0xff, 0xff, // 0x0B no device
      0xff, 0xff, // 0x0C no device
      0xff, 0xff, // 0x0D no device
      0xff, 0xff, // 0x0E no device
      0xff, 0xff, // 0x0F no device
    ]
      .map(d => `0x${d.toString(16).padStart(2, '0')}`)
      .join(',');

    const result = await promisify(exec)(`bin/run --inline-conf '${JSON.stringify(conf)}'`);

    const output = result.stdout
      .split('')
      .filter(char => char.charCodeAt(0) !== 0)
      .join('');

    expect(output).toMatch(`${expected},VM terminated\n`);
  }, 20000);

  it('copy system partition in memory', async() => {
    const bootSector = [
      // R0: current memory address
      // R1: mem addr / current word / comparison result
      // R2: last mem addr
      /* 0x000 */ 0x01, 0x01, 0x20, 0x04, // MOV R1 MEM:0x004
      /* 0x004 */ 0x04, 0x00, 0x01, 0x00, // READ R0 R1
      /* 0x008 */ 0x02, 0x02, 0x00, 0x00, // MOV R2 R0
      /* 0x00C */ 0x0B, 0x02, 0x00, 0xfe, // ADD R2 0x00fe
      /* 0x010 */ 0x0D, 0x00, 0x00, 0x02, // SUB R0 0x0002
      // LOOP START
      /* 0x014 */ 0x0B, 0x00, 0x00, 0x02, // ADD R0 0x0002
      /* 0x018 */ 0x04, 0x01, 0x00, 0x00, // READ R1 R0
      /* 0x01C */ 0x05, 0x01, 0x40, 0x00, // WRITE R1 MOCK:0x000
      /* 0x020 */ 0x02, 0x01, 0x00, 0x00, // MOV R1 R0
      /* 0x024 */ 0x10, 0x01, 0x02, 0x00, // CMP R1 R2
      /* 0x028 */ 0x15, 0x01, 0x30, 0x14, // JL R1 DEV[3]:0x014

      // Shutdown
      /* 0x02C */ 0x01, 0x00, 0x00, 0x00, // MOV R0 PROC_SHUTDOWN
      /* 0x030 */ 0x05, 0x00, 0x10, 0x00, // WRITE R0 PROC:0x000
      /* 0x034 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x038 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x03C */ 0x00, 0x00, 0x00, 0x00,
      /* 0x040 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x044 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x048 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x04C */ 0x00, 0x00, 0x00, 0x00,
      /* 0x050 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x054 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x058 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x05C */ 0x00, 0x00, 0x00, 0x00,
      /* 0x060 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x064 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x068 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x06C */ 0x00, 0x00, 0x00, 0x00,
      /* 0x070 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x074 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x078 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x07C */ 0x00, 0x00, 0x00, 0x00,
      /* 0x080 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x084 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x088 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x08C */ 0x00, 0x00, 0x00, 0x00,
      /* 0x090 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x094 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x098 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x09C */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0A0 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0A4 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0A8 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0AC */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0B0 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0B4 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0B8 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0BC */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0C0 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0C4 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0C8 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0CC */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0D0 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0D4 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0D8 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0DC */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0E0 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0E4 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0E8 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0EC */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0F0 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0F4 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0F8 */ 0x00, 0x00, 0x00, 0x00,
      /* 0x0FC */ 0x00, 0x00, 0x00, 0x00,
    ];
    const conf = {
      firmware: 'src/firmware/firmware.js',
      devices: {
        '0x3': {
          type: 'storage-memory',
          data: bootSector,
        },
        '0x4': {
          file: 'tests/firmware/mock-device',
          data: [],
        },
      },
    };
    const expected = bootSector
      .map(d => `0x${d.toString(16).padStart(2, '0')}`)
      .join(',');

    const result = await promisify(exec)(`bin/run --inline-conf '${JSON.stringify(conf)}'`);

    const output = result.stdout
      .split('')
      .filter(char => char.charCodeAt(0) !== 0)
      .join('');

    expect(output).toMatch(`${expected},VM terminated\n`);
  }, 40000);
});
